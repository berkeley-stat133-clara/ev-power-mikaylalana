---
title: "EV Power - Lab 4 Project Report"
format: typst
Name: "Mikayla Mills"
---

# Example Solution 1

## **Part 0: libraries**

```{r}

```

## **Part 1:** **Defining Research Question**

Chosen Question:

## **Part 2: Data Preparation and Cleaning**

```{r}
## tuse_22 energy_source cleaning (mirror your 2021 style)
tuse_21 <- tuse_21 %>%
  mutate(
    energy_source = tolower(energy_source),
    energy_source = gsub("†|‡", "", energy_source),
    energy_source = gsub("\\(btu\\)", " btu", energy_source),
    energy_source = gsub("[^a-z0-9 _-]", "", energy_source),
    energy_source = gsub("-", "_", energy_source),
    energy_source = gsub(" +", "_", energy_source)
  ) %>%
  mutate(
    energy_source = ifelse(energy_source %in% c("coal_consumption","coal_usage", "coal"),
                           "coal_consumption", energy_source),
    energy_source = ifelse(energy_source %in% c("natural_gas","naturalgas"),
                           "natural_gas", energy_source),
    energy_source = ifelse(energy_source == "petroleum_btu", "petroleum_btu", energy_source),
    energy_source = ifelse(energy_source %in% c("nuclear_energy","nuclear_energy_"),
                           "nuclear_energy", energy_source),
    energy_source = ifelse(energy_source %in% c("total_renewable_energy",
                                                "total_renewable_energy_",
                                                "total_renewables"),
                           "total_renewable_energy21", energy_source)
  )

tuse_22 <- tuse_22 %>%
  mutate(
    energy_source = tolower(energy_source),
    energy_source = gsub("†|‡", "", energy_source),
    energy_source = gsub("\\(btu\\)", " btu", energy_source),
    energy_source = gsub("[^a-z0-9 _-]", "", energy_source),
    energy_source = gsub("-", "_", energy_source),
    energy_source = gsub(" +", "_", energy_source)
  ) %>%
  mutate(
    energy_source = ifelse(energy_source %in% c("coal_consumption","coal_usage"),
                           "coal_consumption", energy_source),
    energy_source = ifelse(energy_source %in% c("natural_gas","naturalgas"),
                           "natural_gas", energy_source),
    energy_source = ifelse(energy_source == "petroleum_btu", "petroleum_btu", energy_source),
    energy_source = ifelse(energy_source %in% c("nuclear_energy","nuclear_energy_"),
                           "nuclear_energy", energy_source),
    energy_source = ifelse(energy_source %in% c("total_renewables","total_renewable_energy"),
                           "total_renewable_energy22", energy_source)
  )

## tuse_23 energy_source cleaning (align names)
tuse_23 <- tuse_23 %>%
  mutate(
    energy_source = tolower(energy_source),
    energy_source = gsub("†|‡", "", energy_source),
    energy_source = gsub("\\(btu\\)", " btu", energy_source),
    energy_source = gsub("[^a-z0-9 _-]", "", energy_source),
    energy_source = gsub("-", "_", energy_source),
    energy_source = gsub(" +", "_", energy_source)
  ) %>%
  mutate(
    energy_source = ifelse(energy_source %in% c("coal_consumption","coal_usage"),
                           "coal_consumption", energy_source),
    energy_source = ifelse(energy_source %in% c("natural_gas","naturalgas"),
                           "natural_gas", energy_source),
    energy_source = ifelse(energy_source == "petroleum_btu", "petroleum_btu", energy_source),
    energy_source = ifelse(energy_source %in% c("nuclear_energy","nuclear_energy_"),
                           "nuclear_energy", energy_source),
    energy_source = ifelse(energy_source %in% c("total_renewable_energy",
                                                "total_renewable_energy_",
                                                "total_renewables"),
                           "total_renewable_energy23", energy_source)
  )



```

## **Part 3: Joining / Pivoting Datasets for Analysis**

```{r}
tuse_21_long <- tuse_21 %>%
  pivot_longer(cols = -energy_source,
               names_to = "state", values_to = "total_energy_use") %>%
  mutate(state = toupper(state), year = 2021L)
tuse_21_long

tuse_22_long <- tuse_22 %>%
  pivot_longer(cols = -energy_source,
               names_to = "state", values_to = "total_energy_use") %>%
  mutate(state = toupper(state), year = 2022L)
tuse_22_long

tuse_23_long <- tuse_23 %>%
  pivot_longer(cols = -energy_source,
               names_to = "state", values_to = "total_energy_use") %>%
  mutate(state = toupper(state), year = 2023L)
tuse_23_long

tuse_long <- bind_rows(tuse_21_long, tuse_22_long, tuse_23_long)


tuse_long <- tuse_long %>%
  mutate(energy_source = trimws(energy_source))


peek <- tuse_long %>%
  filter(grepl("renew", energy_source, ignore.case = TRUE)) %>%
  distinct(year, energy_source) %>%
  arrange(year, energy_source) %>%
  print(n = 100)
peek


renewable_total_rows <- tuse_long %>%
  distinct(energy_source) %>%
  filter(grepl("^total.*renew", energy_source, ignore.case = TRUE)) %>%
  pull(energy_source)
renewable_total_rows

tuse_totals <- tuse_long %>%
  filter(!grepl("^total", energy_source, ignore.case = TRUE)) %>%
  group_by(state, year) %>%
  summarise(total_energy_all = sum(total_energy_use, na.rm = TRUE), .groups = "drop")
tuse_totals


tuse_total_renewable_from_totalrow <- tuse_long %>%
  filter(energy_source %in% renewable_tot_rows) %>%
  group_by(state, year) %>%
  summarise(total_energy_renewable = sum(total_energy_use, na.rm = TRUE), .groups = "drop")
tuse_total_renewable_from_totalrow


renew_patterns <- "(solar|wind|hydro|water|geotherm|biomass|biofuel|wood|waste)"
tuse_total_renewable_from_components <- tuse_long %>%
  filter(!grepl("^total", energy_source, ignore.case = TRUE)) %>%
  filter(grepl(renew_patterns, energy_source, ignore.case = TRUE)) %>%
  group_by(state, year) %>%
  summarise(total_energy_renewable_components = sum(total_energy_use, na.rm = TRUE),
            .groups = "drop")
tuse_total_renewable_from_components


tuse_total_renewable <- tuse_total_renewable_from_totalrow %>%
  full_join(tuse_total_renewable_from_components, by = c("state","year")) %>%
  mutate(total_energy_renewable = dplyr::coalesce(total_energy_renewable, total_energy_renewable_components)) %>%
  select(state, year, total_energy_renewable)
tuse_total_renewable


tuse_totals %>%
  anti_join(tuse_total_renewable, by = c("state","year")) %>%
  arrange(year, state) %>%
  print(n = 100)


grid_clean <- tuse_totals %>%
  left_join(tuse_total_renewable, by = c("state","year")) %>%
  mutate(
    renewable_share = total_energy_renewable / pmax(total_energy_all, 1e-9),
    fossil_share    = 1 - renewable_share
  )
grid_clean

## 7) 2023 ranking
cleanliness_2023 <- grid_clean %>%
  filter(year == 2023L, state %in% c(state.abb, "DC")) %>%
  arrange(desc(renewable_share)) %>%
  mutate(
    clean_e_levels = case_when(
      renewable_share >= 0.60 ~ "Clean (≥60% renewable)",
      renewable_share >= 0.40 ~ "Moderately clean (40–59%)",
      renewable_share >= 0.20 ~ "Mixed (20–39%)",
      TRUE                    ~ "Fossil-heavy (<20%)"
    )
)
cleanliness_2023 

cleanliness_2023 %>%
  arrange(desc(renewable_share)) %>%
  mutate(renewable_share = round(100 * renewable_share, 1),
         fossil_share    = round(100 * fossil_share, 1)) %>%
  select(state, renewable_share, fossil_share, clean_e_levels)



#“Does charging electricity come from clean sources?”
# Rank states by renewable_share (higher = cleaner grid)

```

## **Part 4: Mapping Visualization**

```{r}
state_map <- data.frame(
  state_abb  = state.abb,
  state_full = tolower(state.name),
  stringsAsFactors = FALSE
)

map_2023 <- cleanliness_2023 %>%
  filter(state %in% state.abb) %>%
  left_join(state_map, by = c("state" = "state_abb")) %>%
  select(state_full, renewable_share, clean_bucket)

us_poly <- map_data("state")
plot_df <- us_poly %>%
  left_join(map_2023, by = c("region" = "state_full"))

ggplot(plot_df, aes(long, lat, group = group, fill = clean_bucket)) +
  geom_polygon(color = "white", size = 0.25) +
  coord_fixed(1.3) +
  scale_fill_brewer(palette = "YlGnBu", direction = 1, na.value = "grey90", name = "Category") +
  labs(
    title = "Grid Cleanliness by State (2023)",
    subtitle = "Buckets based on renewable share",
    caption = "Source: your cleaned tuse_2021–2023 tables"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.position = "right"
  )
```